<!-- admin_wizard.html -->
<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Wizard - Cardápio (Front)</title>
<style>
  :root{
    --bg:#ffffff; --muted:#6b7280; --accent:#0b74de;
    --card:#f8fafc; --border:#e6eef8; --danger:#c0392b;
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Arial,sans-serif;background:#f1f5f9;margin:0;padding:24px;color:#111}
  .wrap{max-width:1200px;margin:0 auto}
  .card{background:var(--bg);border-radius:10px;padding:20px;box-shadow:0 8px 30px rgba(16,24,40,.06)}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  h1{font-size:18px;margin:0}
  .sub{color:var(--muted);font-size:13px}
  .steps{display:flex;gap:8px;margin:16px 0}
  .step{padding:8px 12px;border-radius:8px;background:var(--card);color:var(--muted);font-weight:600;font-size:13px}
  .step.active{background:var(--accent);color:#fff}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
  .panel{background:#fff;border:1px solid var(--border);border-radius:8px;padding:12px}
  label{display:block;font-size:13px;color:var(--muted);margin-top:10px}
  input[type=text],select,textarea{width:100%;padding:10px;border:1px solid #e6eef8;border-radius:8px;margin-top:6px;font-size:14px}
  textarea{min-height:80px;resize:vertical}
  .list{min-height:220px;border:1px dashed #e6eef8;border-radius:6px;padding:8px;overflow:auto;background:#fbfdff}
  .item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #f1f6fb}
  .item:last-child{border-bottom:0}
  .muted{color:var(--muted);font-size:13px}
  .btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
  .btn.ghost{background:#fff;color:var(--accent);border:1px solid #e6eef8}
  .btn.small{padding:6px 10px;font-size:13px}
  footer{display:flex;justify-content:space-between;align-items:center;margin-top:14px}
  .preview{background:#0b1220;color:#fff;padding:12px;border-radius:8px;font-size:14px}
  .row{display:flex;gap:8px}
  .col{flex:1}
  .mini{font-size:12px;color:var(--muted)}
  .error{color:var(--danger)}
  @media(max-width:980px){.grid{grid-template-columns:1fr;}.steps{flex-wrap:wrap}}
</style>
</head>
<body>
<div class="wrap">
  <div class="card" role="main" aria-labelledby="title">
    <header>
      <div>
        <h1 id="title">Wizard — Cardápio (Front)</h1>
        <div class="sub">Crie categorias, produtos, ingredientes e preços. Salve para o backend.</div>
      </div>
      <div class="mini" id="statusBar">Offline</div>
    </header>

    <div class="steps" id="steps">
      <div class="step active" data-step="1">1. Categoria</div>
      <div class="step" data-step="2">2. Produto</div>
      <div class="step" data-step="3">3. Ingredientes</div>
      <div class="step" data-step="4">4. Preços</div>
      <div class="step" data-step="5">5. Preview</div>
    </div>

    <div class="grid">
      <div>
        <!-- STEP PANE -->
        <div class="panel" id="paneCategory">
          <label>Selecionar categoria</label>
          <select id="selectCategory"></select>
          <label>Ou criar nova categoria</label>
          <input id="cat_name" type="text" placeholder="Nome da categoria (ex.: Pizzas Tradicionais)">
          <label>Ícone (opcional)</label>
          <input id="cat_icon" type="text" placeholder="fa-pizza-slice">
          <div style="margin-top:12px">
            <button class="btn" id="btnCategoryNext">Continuar</button>
          </div>
        </div>

        <div class="panel" id="paneProduct" style="display:none;margin-top:12px">
          <label>Nome do produto</label>
          <input id="prod_name" type="text" placeholder="Ex.: Calabresa">
          <label>Descrição</label>
          <textarea id="prod_desc" placeholder="Breve descrição"></textarea>

          <div class="row" style="margin-top:10px">
            <div class="col">
              <label>Tamanho padrão</label>
              <select id="prod_size"><option>P</option><option selected>M</option><option>G</option><option>GG</option></select>
            </div>
            <div style="width:140px">
              <label>Disponível?</label>
              <select id="prod_available"><option value="1">Sim</option><option value="0">Não</option></select>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn ghost" id="btnProdBack">Voltar</button>
            <button class="btn" id="btnProdNext">Continuar</button>
          </div>
        </div>

        <div class="panel" id="paneIngredients" style="display:none;margin-top:12px">
          <label>Adicionar ingrediente</label>
          <div class="row">
            <input id="ing_name" type="text" placeholder="Ex.: Presunto">
            <input id="ing_qtd" type="text" placeholder="Opcional (ex.: 100g)" style="width:160px">
          </div>
          <div style="margin-top:10px">
            <button class="btn small" id="btnAddIngredient">Adicionar ingrediente</button>
            <button class="btn ghost small" id="btnIngBack">Voltar</button>
            <button class="btn small" id="btnIngNext">Continuar</button>
          </div>
          <div style="margin-top:12px">
            <label>Ingredientes</label>
            <div class="list" id="ingredientsList">Nenhum ingrediente</div>
          </div>
        </div>

        <div class="panel" id="panePrices" style="display:none;margin-top:12px">
          <label>Preços por tamanho</label>
          <div class="row">
            <input id="price_p" type="text" placeholder="P">
            <input id="price_m" type="text" placeholder="M">
            <input id="price_g" type="text" placeholder="G">
            <input id="price_gg" type="text" placeholder="GG">
          </div>

          <label style="margin-top:10px">Extras (formato: Nome|Preço separado por vírgula)</label>
          <textarea id="extras" placeholder="Catupiry|12,Bacon|10"></textarea>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn ghost" id="btnPricesBack">Voltar</button>
            <button class="btn" id="btnPricesNext">Continuar</button>
          </div>
        </div>

        <div class="panel" id="panePreview" style="display:none;margin-top:12px">
          <label>Preview e salvar</label>
          <div class="list" id="fullPreview" style="height:360px;overflow:auto"></div>
          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
            <button class="btn ghost" id="btnPreviewBack">Voltar</button>
            <button class="btn" id="btnSaveMenu">Salvar cardápio</button>
            <div id="saveStatus" class="muted" style="margin-left:12px"></div>
          </div>
        </div>
      </div>

      <aside>
        <div class="panel">
          <label>Categorias existentes</label>
          <div class="list" id="categoriesList">Carregando...</div>

          <label style="margin-top:10px">Produtos (seleção)</label>
          <div class="list" id="productsList" style="height:240px">Carregando...</div>
        </div>

        <div class="panel" style="margin-top:12px">
          <label>Preview rápido</label>
          <div class="preview" id="quickPreview">Preencha dados para ver preview</div>
        </div>
      </aside>
    </div>

    <footer>
      <div class="muted">Wizard admin — ajuste API endpoints no código se necessário.</div>
      <div>
        <button class="btn ghost" id="btnDownload">Download JSON</button>
        <button class="btn ghost" id="btnReset">Reset local</button>
      </div>
    </footer>
  </div>
</div>

<script>
/*
  Front wizard logic.
  Adjust API endpoints here:
*/
const API_GET = '/api/menu_get.php';
const API_SAVE = '/api/menu_save.php';

let state = { categories: [], products: [], currentCategoryId: null, currentProduct: null };

const qs = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));

/* Init */
async function init() {
  setStatus('Conectando...');
  await loadMenu();
  wire();
  setStatus('Pronto');
  renderAll();
}

function setStatus(txt) { qs('#statusBar').textContent = txt; }

async function loadMenu() {
  try {
    const res = await fetch(API_GET, { credentials: 'include' });
    const j = await res.json();
    if (j.ok && j.categories && j.products) {
      state.categories = j.categories.map(c => ({ id: c.id || c.nome, nome: c.nome, icone: c.icone || '', descricao: c.descricao || '' }));
      state.products = j.products.map(p => ({
        id: p.id || Date.now()+Math.random(),
        categoria_id: p.categoria_id || (state.categories[0] && state.categories[0].id) || null,
        nome: p.nome || '',
        descricao: p.descricao || '',
        preco_p: p.preco_p || 0,
        preco_m: p.preco_m || 0,
        preco_g: p.preco_g || 0,
        preco_gg: p.preco_gg || 0,
        disponivel: p.disponivel ? 1 : 0,
        ingredientes: p.ingredientes || [],
        extras: p.extras || []
      }));
    } else {
      // fallback empty
      state.categories = [];
      state.products = [];
    }
  } catch (e) {
    console.error(e);
    state.categories = [];
    state.products = [];
  }
}

function wire() {
  qs('#btnCategoryNext').addEventListener('click', onCategoryNext);
  qs('#btnProdBack').addEventListener('click', ()=>goStep(1));
  qs('#btnProdNext').addEventListener('click', onProdNext);
  qs('#btnAddIngredient').addEventListener('click', onAddIngredient);
  qs('#btnIngBack').addEventListener('click', ()=>goStep(2));
  qs('#btnIngNext').addEventListener('click', ()=>goStep(4));
  qs('#btnPricesBack').addEventListener('click', ()=>goStep(3));
  qs('#btnPricesNext').addEventListener('click', onPricesNext);
  qs('#btnPreviewBack').addEventListener('click', ()=>goStep(4));
  qs('#btnSaveMenu').addEventListener('click', saveMenu);
  qs('#btnDownload').addEventListener('click', downloadJSON);
  qs('#btnReset').addEventListener('click', resetLocal);

  qs('#selectCategory').addEventListener('change', e=>{
    const v = e.target.value;
    state.currentCategoryId = v || null;
    renderProductsList();
  });
}

function renderAll() {
  renderCategories();
  renderProductsList();
  renderIngredients();
  renderPreview();
  renderQuickPreview();
}

function renderCategories(){
  const sel = qs('#selectCategory'); const list = qs('#categoriesList');
  sel.innerHTML = '<option value="">-- Nova categoria --</option>';
  list.innerHTML = '';
  state.categories.forEach(c=>{
    const id = c.id;
    const opt = document.createElement('option'); opt.value = id; opt.textContent = c.nome; sel.appendChild(opt);
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `<div><strong>${c.nome}</strong><div class="muted">${c.descricao||''}</div></div>
      <div><button class="btn ghost small" onclick="useCategory('${escapeHtml(id)}')">Usar</button></div>`;
    list.appendChild(div);
  });
}

function useCategory(id){
  state.currentCategoryId = id;
  qs('#selectCategory').value = id;
  goStep(2);
}

function renderProductsList(){
  const container = qs('#productsList');
  const catId = state.currentCategoryId;
  const list = state.products.filter(p => !catId || String(p.categoria_id) === String(catId));
  if (list.length===0) { container.innerHTML = '<div class="muted">Nenhum produto</div>'; return; }
  container.innerHTML = '';
  list.forEach(p=>{
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `<div><strong>${p.nome}</strong><div class="muted">${p.descricao||''}</div></div>
      <div style="display:flex;gap:6px">
        <button class="btn ghost small" onclick="editProduct(${p.id})">Editar</button>
      </div>`;
    container.appendChild(div);
  });
}

function editProduct(id){
  const p = state.products.find(x=>x.id==id);
  if (!p) return;
  state.currentProduct = JSON.parse(JSON.stringify(p));
  // prefill
  qs('#prod_name').value = p.nome;
  qs('#prod_desc').value = p.descricao;
  qs('#prod_size').value = p.tamanho_default || 'M';
  qs('#prod_available').value = p.disponivel ? '1':'0';
  qs('#price_p').value = p.preco_p || '';
  qs('#price_m').value = p.preco_m || '';
  qs('#price_g').value = p.preco_g || '';
  qs('#price_gg').value = p.preco_gg || '';
  qs('#extras').value = (p.extras || []).map(x=>`${x.nome}|${x.preco}`).join(',');
  renderIngredients();
  goStep(3);
  renderQuickPreview();
}

function onCategoryNext(){
  const sel = qs('#selectCategory').value;
  const name = qs('#cat_name').value.trim();
  const icon = qs('#cat_icon').value.trim();
  if (!sel && !name) return alert('Escolha ou crie uma categoria');
  if (!sel) {
    const newid = 'local_'+Date.now();
    state.categories.push({ id: newid, nome: name, icone: icon, descricao:'' });
    state.currentCategoryId = newid;
    renderCategories();
  } else {
    state.currentCategoryId = sel;
  }
  goStep(2);
  renderProductsList();
}

function onProdNext(){
  const name = qs('#prod_name').value.trim();
  if (!name) return alert('Nome do produto é obrigatório');
  state.currentProduct = state.currentProduct || {};
  state.currentProduct.nome = name;
  state.currentProduct.descricao = qs('#prod_desc').value.trim();
  state.currentProduct.tamanho_default = qs('#prod_size').value;
  state.currentProduct.disponivel = qs('#prod_available').value === '1' ? 1 : 0;
  state.currentProduct.categoria_id = state.currentCategoryId;
  if (!state.currentProduct.id) state.currentProduct.id = 'tmp_'+Date.now();
  goStep(3);
}

function onAddIngredient(){
  const name = qs('#ing_name').value.trim();
  const qtd = qs('#ing_qtd').value.trim();
  if (!name) return alert('Ingrediente obrigatório');
  state.currentProduct = state.currentProduct || {};
  state.currentProduct.ingredientes = state.currentProduct.ingredientes || [];
  state.currentProduct.ingredientes.push({ nome, qtd });
  qs('#ing_name').value=''; qs('#ing_qtd').value='';
  renderIngredients();
  renderQuickPreview();
}

function onPricesNext(){
  const pP = parseFloat(qs('#price_p').value || 0) || 0;
  const pM = parseFloat(qs('#price_m').value || 0) || 0;
  const pG = parseFloat(qs('#price_g').value || 0) || 0;
  const pGG = parseFloat(qs('#price_gg').value || 0) || 0;
  state.currentProduct.preco_p = pP; state.currentProduct.preco_m = pM; state.currentProduct.preco_g = pG; state.currentProduct.preco_gg = pGG;
  const extrasRaw = qs('#extras').value.trim();
  state.currentProduct.extras = extrasRaw ? extrasRaw.split(',').map(s=>{
    const parts = s.split('|').map(x=>x.trim());
    return { nome: parts[0]||'', preco: parseFloat(parts[1]||0) || 0 };
  }) : [];
  // push or update products list
  if (!state.currentProduct.id || String(state.currentProduct.id).startsWith('tmp_')) {
    state.currentProduct.id = Date.now() + Math.floor(Math.random()*999);
    state.products.push(state.currentProduct);
  } else {
    const idx = state.products.findIndex(x=>x.id==state.currentProduct.id);
    if (idx>=0) state.products[idx] = state.currentProduct;
    else state.products.push(state.currentProduct);
  }
  renderProductsList();
  goStep(5);
  renderPreview();
}

function renderIngredients(){
  const list = qs('#ingredientsList');
  const arr = (state.currentProduct && state.currentProduct.ingredientes) || [];
  if (arr.length===0) { list.innerHTML = '<div class="muted">Nenhum ingrediente</div>'; return; }
  list.innerHTML = arr.map(i=>`<div class="item"><div>${i.nome} <div class="muted">${i.qtd||''}</div></div>
    <div><button class="btn ghost small" onclick="removeIngredient('${escapeHtml(i.nome)}')">Remover</button></div></div>`).join('');
}

function removeIngredient(name){
  if (!state.currentProduct) return;
  state.currentProduct.ingredientes = (state.currentProduct.ingredientes || []).filter(i => i.nome !== name);
  renderIngredients();
}

function renderQuickPreview(){
  const p = state.currentProduct || {};
  const txt = `${p.nome || 'Produto'} — ${p.descricao||''}\nP:${p.preco_p||'-'} M:${p.preco_m||'-'} G:${p.preco_g||'-'} GG:${p.preco_gg||'-'}\nIngredientes: ${(p.ingredientes||[]).map(x=>x.nome).join(', ')}`;
  qs('#quickPreview').textContent = txt;
}

function renderPreview(){
  const container = qs('#fullPreview');
  if (state.categories.length===0) { container.innerHTML = '<div class="muted">Sem categorias</div>'; return; }
  let html = '';
  state.categories.forEach(cat=>{
    const prods = state.products.filter(p => String(p.categoria_id) === String(cat.id));
    if (prods.length===0) return;
    html += `<div style="margin-bottom:8px"><h3 style="margin:6px 0">${cat.nome}</h3>`;
    prods.forEach(p=>{
      html += `<div style="padding:8px;border-bottom:1px solid #f1f6fb">
        <strong>${p.nome}</strong>
        <div class="muted">${p.descricao||''}</div>
        <div class="muted">P:${p.preco_p||'-'} M:${p.preco_m||'-'} G:${p.preco_g||'-'} GG:${p.preco_gg||'-'}</div>
        <div class="muted">Ingredientes: ${(p.ingredientes||[]).map(i=>i.nome+(i.qtd?(' ('+i.qtd+')'): '')).join(', ')}</div>
      </div>`;
    });
    html += '</div>';
  });
  container.innerHTML = html || '<div class="muted">Nenhum produto criado.</div>';
}

function goStep(n){
  qsa('.step').forEach(s => s.classList.toggle('active', Number(s.dataset.step) === n));
  qs('#paneCategory').style.display = n===1 ? 'block' : 'none';
  qs('#paneProduct').style.display = n===2 ? 'block' : 'none';
  qs('#paneIngredients').style.display = n===3 ? 'block' : 'none';
  qs('#panePrices').style.display = n===4 ? 'block' : 'none';
  qs('#panePreview').style.display = n===5 ? 'block' : 'none';
  if (n===5) renderPreview();
}

async function saveMenu(){
  qs('#saveStatus').textContent = 'Salvando...';
  const payload = { categories: state.categories, products: state.products };
  try {
    const res = await fetch(API_SAVE, {
      method: 'POST',
      credentials: 'include',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const j = await res.json();
    if (!res.ok) throw j;
    qs('#saveStatus').textContent = 'Salvo';
    setStatus('Salvo: ' + (j.message || 'OK'));
  } catch (e) {
    console.error(e);
    qs('#saveStatus').innerHTML = '<span class="error">Erro ao salvar</span>';
    setStatus('Erro ao salvar');
  }
}

function downloadJSON(){
  const data = JSON.stringify({ categories: state.categories, products: state.products }, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'menu_wizard.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

function resetLocal(){
  if (!confirm('Resetar dados locais?')) return;
  state = { categories: [], products: [], currentCategoryId: null, currentProduct: null };
  renderAll();
  setStatus('Resetado');
}

/* small helper */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

init();
</script>
</body>
</html>
